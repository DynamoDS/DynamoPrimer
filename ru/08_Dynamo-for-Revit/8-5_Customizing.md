

## Адаптация

Ранее мы рассмотрели редактирование базового формообразующего элемента здания. Теперь мы предлагаем подробнее изучить взаимодействие Dynamo и Revit путем редактирования большого количества элементов за один подход. Адаптация усложняется при увеличении масштаба, так как структура данных требует более сложных операций со списками. Однако основные принципы работы при этом остаются прежними. Рассмотрим возможности расчета с помощью набора адаптивных компонентов.

#### Местоположение точки

Предположим, что вы создали набор адаптивных компонентов и хотите отредактировать параметры на основании местоположений точек. Например, точки могут определять параметр толщины, который связан с площадью элемента. Кроме того, они могут отвечать за параметр непрозрачности, связанный с уровнем инсоляции за год. Dynamo позволяет связать расчет с параметрами за несколько простых шагов. Основы этого процесса будут приведены в упражнениях ниже.

![Точки](images/8-5/points.jpg)

> Опросите адаптивные точки выбранного адаптивного компонента с помощью узла *AdaptiveComponent.Locations*. Это позволяет выполнить расчет для абстрагированной версии элемента Revit.

Получив местоположение точек адаптивных компонентов, можно запустить несколько расчетов для элемента. Например, адаптивный компонент по четырем точкам позволяет изучить отклонение от плоскости для заданной панели.

#### Расчет ориентации относительно солнца

![Точки](images/8-5/points.jpg)

> Используя повторное сопоставление, можно сопоставить набор данных с диапазоном параметров. Это основной инструмент параметрического моделирования, который вы сможете изучить подробнее, выполнив упражнение ниже.

В Dynamo местоположения точек адаптивных компонентов можно использовать для создания плоскости наилучшего вписывания для каждого элемента. Кроме того, можно запросить положение солнца в файле Revit и изучить относительную ориентацию плоскости к солнцу по сравнению с другими адаптивными компонентами. Давайте выполним это путем создания алгоритмической кровли в упражнении ниже.

### Упражнение

> Скачайте файлы примера для этого упражнения (щелкните правой кнопкой мыши и выберите «Сохранить ссылку как...»). Полный список файлов примеров можно найти в приложении.

> 1. [Customizing.dyn](datasets/8-5/Customizing.dyn)
2. [ARCH-Customizing-BaseFile.rvt](datasets/8-5/ARCH-Customizing-BaseFile.rvt)

В данном упражнении будут подробнее рассмотрены техники из предыдущего раздела. Вам понадобится определить параметрическую поверхность на основе элементов Revit, создать экземпляры адаптивных компонентов по четырем точкам, а затем отредактировать их на основании ориентации относительно солнца.

![Упражнение](images/8-5/Exercise/00.jpg)

> 1. Для начала выберите два ребра с помощью узла *Select Edge*. Два ребра представляют собой длинные пролеты атриума.
2. Объедините два ребра в один список, используя узел *List.Create*.
3. Создайте поверхность между двумя ребрами с помощью узла *Surface.ByLoft*.

![Упражнение](images/8-5/Exercise/01.jpg)

> 1. В узле *Code Block* задайте диапазон от 0 до 1 с 10 равномерно распределенными значениями: ```0..1..#10;```.
2. Соедините *Code Block* с портами ввода *u* и *v* узла *Surface.PointAtParameter*, а также соедините узел *Surface.ByLoft* с портом ввода *surface*. Щелкните узел правой кнопкой мыши и задайте для параметра *Переплетение* значение *Декартово произведение*. На поверхности появится сетка из точек.

Эта сетка из точек служит в качестве управляющих точек для параметрической поверхности. Необходимо извлечь положения u и v каждой из этих точек, чтобы ввести их в параметрическую формулу и сохранить существующую структуру данных. Это можно сделать, запросив местоположения параметров только что созданных точек.

![Упражнение](images/8-5/Exercise/02.jpg)

> 1. Добавьте узел *Surface.ParameterAtPoint* в рабочую область и соедините порты ввода, как показано выше.
2. Запросите значения *u* для этих параметров с помощью узла *UV.U*.
3. Запросите значения *v* для этих параметров с помощью узла *UV.V*.
4. В выходных данных отображаются соответствующие значения *u* и *v* для каждой точки поверхности. Вы получили диапазон от *0* до *1* для каждого значения, обеспечена правильная структура данных, и можно применять параметрический алгоритм.

![Упражнение](images/8-5/Exercise/03.jpg)

> 1. Добавьте узел *Code Block* в рабочую область и введите код: ```Math.Sin(u*180)*Math.Sin(v*180)*w;```. Это параметрическая функция, которая создает синусоидную выпуклость на основе плоской поверхности.
2. Порт ввода *u* соединяется с узлом *UV.U*.
3. Порт ввода *v* соединяется с узлом *UV.V*.
4. Порт ввода *w* представляет *амплитуду* формы, поэтому к нему нужно присоединить узел *Number Slider*.

![Упражнение](images/8-5/Exercise/04.jpg)

> 1. Теперь у вас есть список значений в соответствии с алгоритмом. Используйте этот список для перемещения точек вверх по оси *+Z*. Используя узел *Geometry.Translate*, соедините *Code Block *с портом ввода *zTranslation*, а *Surface.PointAtParameter* — с портом ввода *geometry*. В области предварительного просмотра Dynamo отображаются новые точки.
2. Наконец, создайте поверхность с помощью узла *NurbsSurface.ByPoints*, соединив узел из предыдущего шага с портом ввода points. В результате получается параметрическая поверхность. Перетаскивайте регулятор, чтобы уменьшить или увеличить выпуклость.

Теперь нам нужно найти способ разбить полученную параметрическую поверхность на панели, чтобы разместить адаптивные компоненты по четырем точкам в формате массива. В Dynamo нет готовой функции для работы с панелями, поэтому обратимся к сообществу пользователей за полезными пакетами Dynamo.

![Упражнение](images/8-5/Exercise/05a.jpg)

> 1. Перейдите к разделу *«Пакеты» > «Поиск пакета...»*.
2. Найдите *LunchBox* и скачайте файл *LunchBox for Dynamo*. Это очень полезный набор инструментов для подобных операций с геометрией.

![Упражнение](images/8-5/Exercise/07.jpg)

> 1. После скачивания вы получите полный доступ к пакету LunchBox. Найдите *Quad Grid* и выберите *LunchBox Quad Grid By Face*. Соедините параметрическую поверхность с портом ввода *surface* и установите деления *U* и *V* на *15*. В области предварительного просмотра Dynamo должна отобразиться поверхность с прямоугольными панелями.

![Упражнение](images/8-5/Exercise/customNode.jpg)

> Если вас заинтересовала ее настройка, дважды щелкните узел *Lunch Box* и просмотрите параметры.

![Упражнение](images/8-5/Exercise/08.jpg)

> Вернитесь в Revit, чтобы узнать, какой адаптивный компонент используется в этой программе. Нет необходимости его повторять, но это панель крыши, которая будет использоваться в качестве экземпляра массива. Это адаптивный компонент по четырем точкам, который является грубым представлением системы ЭТФЭ. Апертура центральной полости находится на параметре *ApertureRatio*.

![Упражнение](images/8-5/Exercise/09.jpg)

> 1. Так как вы собираетесь создать большое количество экземпляров геометрии в Revit, убедитесь, что решатель Dynamo находится в *ручном* режиме.
2. Добавьте узел *Family Types* в рабочую область и выберите *ROOF-PANEL-4PT*.
3. Добавьте узел *AdaptiveComponent.ByPoints* в рабочую область, соедините порт вывода *Panel Pts* узла *LunchBox Quad Grid by Face* с портом ввода *points*. Соедините узел *Family Types* с портом ввода *familySymbol*.
4. Нажмите кнопку *Запуск*. Для создания геометрии программе Revit потребуется немного времени *на раздумья*. Если это занимает слишком много времени, слегка уменьшите значение 15 в узле *Code Block*. Это уменьшит количество панелей на крыше.

*Примечание. Если Dynamo требуется много времени для расчета узлов, возможно, вам следует воспользоваться функцией заморозки, чтобы поставить на паузу выполнение операций Revit во время создания графика. Для получения дополнительных сведений о заморозке узлов ознакомьтесь с разделом, посвященным заморозке, в [главе о твердых телах](../05_Geometry-for-Computational-Design/5-6_solids.md#freezing).*

![Упражнение](images/8-5/Exercise/31.jpg)

> В Revit мы видим массив панелей на крыше.

![Упражнение](images/8-5/Exercise/30.jpg)

> Увеличив масштаб, можно детально рассмотреть свойства их поверхности.

### Анализ

![Упражнение](images/8-5/Exercise/16.jpg)

> 1. Используя результаты, полученные на предыдущем шаге, настройте апертуру каждой панели с учетом инсоляции. Увеличьте масштаб в Revit и выберите одну панель, чтобы увидеть на панели свойств параметр *коэффициента апертуры*. В настройках семейства задан диапазон апертуры от *0,05* до *0,45*.

![Упражнение](images/8-5/Exercise/17.jpg)

> 1. Если включить траекторию солнца, можно увидеть текущее положение солнца в Revit.

![Упражнение](images/8-5/Exercise/13.jpg)

> 1. С помощью узла *SunSettings.Current* можно задать положение солнца в качестве опорного значения.
2. Соедините узел SunSettings с узлом *Sunsetting.SunDirection*, чтобы получить вектор солнца.
3. На основе значения, полученного из порта вывода *Panel Pts*, использованного для создания адаптивных компонентов, выполните аппроксимацию плоскости для компонента с помощью узла *Plane.ByBestFitThroughPoints*.
4. Запросите *нормаль* этой плоскости.
5. Для расчета ориентации инсоляции используйте *скалярное произведение*. Скалярное произведение — это формула, которая определяет, насколько параллельны или не параллельны два вектора. Чтобы приблизительно смоделировать ориентацию инсоляции, вы сравниваете нормаль плоскости каждого адаптивного компонента с вектором солнца.
6. Извлеките *абсолютное значение* результата. Это гарантирует точность скалярного произведения, если нормаль плоскости повернута в обратном направлении.
7. Нажмите кнопку *Запуск*.

![Упражнение](images/8-5/Exercise/14.jpg)

> 1. *Скалярное произведение* предоставляет широкий диапазон чисел. Нужно использовать их относительное распределение, однако необходимо объединить числа в соответствующем диапазоне редактируемого параметра *коэффициента апертуры*.
2. Узел *Math.RemapRange* отлично для этого подходит. Он сопоставляет пределы списка входных данных с двумя целевыми значениями.
3. Задайте целевые значения *0,15* и *0,45*** с помощью узла Code Block.
4. Нажмите кнопку *Запуск*.

![Упражнение](images/8-5/Exercise/33.jpg)

> 1. Соедините сопоставленные значения с узлом *Element.SetParameterByName*.
2. Соедините строку *Aperture Ratio* с портом ввода *parameterName*.
3. Соедините элемент *адаптивных компонентов* с портом ввода *element*.
4. Нажмите кнопку *Запуск*.

![Упражнение](images/8-5/Exercise/21.jpg)

> Уменьшив масштаб в Revit, можно изучить влияние ориентации солнца на апертуру панелей ЭТФЭ.

![Упражнение](images/8-5/Exercise/32.jpg)

> При увеличении изображения видно, что панели ЭТФЭ более закрыты по направлению солнца. Цель данного упражнения — уменьшить перегрев из-за инсоляции. Если требуется увеличить проникновение света в помещение на основании инсоляции, просто смените область на *Math.RemapRange*.

